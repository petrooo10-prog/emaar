<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Add Worker</title>
</head>
<body>

<h2>Add New Worker</h2>

<input id="name" placeholder="Full Name"><br><br>
<input id="nationalId" placeholder="National ID"><br><br>
<input id="contractor" placeholder="Contractor Name"><br><br>
<input id="jobTitle" placeholder="Job Title"><br><br>
<input id="gates" placeholder="Gates (comma separated)"><br><br>
<input id="startDate" type="date"><br><br>
<input id="endDate" type="date"><br><br>

<h3>Upload Images (Required)</h3>
<label>Personal Photo:</label>
<input type="file" id="personalPhoto"><br><br>
<label>ID Photo:</label>
<input type="file" id="idPhoto"><br><br>
<label>Criminal Record:</label>
<input type="file" id="criminalPhoto"><br><br>

<button onclick="addWorker()">Add Worker</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB19hTeL7TKpdAx6D7bS9vEtKbYoCmbP90",
  authDomain: "emaar-sp-ids.firebaseapp.com",
  projectId: "emaar-sp-ids",
  storageBucket: "emaar-sp-ids.appspot.com",
  messagingSenderId: "949167965180",
  appId: "1:949167965180:web:46dfa2047895ddb4ac6879"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

async function uploadFile(file, folder, workerId) {
  const ref = storage.ref().child(`${folder}/${workerId}_${file.name}`);
  console.log("Uploading to:", `${folder}/${workerId}_${file.name}`);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  console.log("Uploaded URL:", url);
  return url;
}

async function addWorker() {
  const name = document.getElementById("name").value.trim();
  const nationalId = document.getElementById("nationalId").value.trim();
  const contractor = document.getElementById("contractor").value.trim();
  const jobTitle = document.getElementById("jobTitle").value.trim();
  const gates = document.getElementById("gates").value.trim();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const personalPhotoFile = document.getElementById("personalPhoto").files[0];
  const idPhotoFile = document.getElementById("idPhoto").files[0];
  const criminalPhotoFile = document.getElementById("criminalPhoto").files[0];

  if (!name || !nationalId || !contractor || !jobTitle || !gates || !startDate || !endDate) {
    alert("Please fill all required fields including start and end date.");
    return;
  }

  if (!personalPhotoFile || !idPhotoFile || !criminalPhotoFile) {
    alert("Please upload all required images.");
    return;
  }

  try {
    const counterRef = db.collection("counters").doc("workers");
    const counterDoc = await counterRef.get();
    let lastNumber = counterDoc.exists ? counterDoc.data().lastNumber : 0;
    const newNumber = lastNumber + 1;
    const workerId = "WORKER-" + String(newNumber).padStart(6, "0");

    const personalPhotoURL = await uploadFile(personalPhotoFile, "Personal_photos", workerId);
    const idPhotoURL = await uploadFile(idPhotoFile, "id_photos", workerId);
    const criminalPhotoURL = await uploadFile(criminalPhotoFile, "criminal_records", workerId);

    const data = {
      workerId,
      name,
      nationalId,
      contractor,
      jobTitle,
      gates: gates.split(","),
      startDate,
      endDate,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      personalPhotoURL,
      idPhotoURL,
      criminalPhotoURL
    };

    await db.collection("workers").doc(workerId).set(data);
    await counterRef.update({ lastNumber: newNumber });

    alert("Worker added successfully with ID: " + workerId);
  } catch (error) {
    alert(error.message);
  }
}
</script>

</body>
</html>
