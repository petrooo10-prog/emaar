<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Add Worker</title>
</head>
<body>

<h2>Add New Worker</h2>

<input id="name" placeholder="Full Name"><br><br>
<input id="nationalId" placeholder="National ID"><br><br>
<input id="contractor" placeholder="Contractor Name"><br><br>
<input id="jobTitle" placeholder="Job Title"><br><br>
<input id="gates" placeholder="Gates (comma separated)"><br><br>
<input id="startDate" type="date"><br><br>
<input id="endDate" type="date"><br><br>

<h3>Upload Images</h3>
<label>Personal Photo:</label>
<input type="file" id="personalPhoto"><br><br>
<label>ID Photo:</label>
<input type="file" id="idPhoto"><br><br>
<label>Criminal Record:</label>
<input type="file" id="criminalPhoto"><br><br>

<button onclick="addWorker()">Add Worker</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB19hTeL7TKpdAx6D7bS9vEtKbYoCmbP90",
  authDomain: "emaar-sp-ids.firebaseapp.com",
  projectId: "emaar-sp-ids",
  storageBucket: "emaar-sp-ids.appspot.com",
  messagingSenderId: "949167965180",
  appId: "1:949167965180:web:46dfa2047895ddb4ac6879"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

async function uploadFile(file, path) {
  const ref = storage.ref().child(path);
  await ref.put(file);
  return await ref.getDownloadURL();
}

async function addWorker() {
  try {
    const counterRef = db.collection("counters").doc("workers");
    const counterDoc = await counterRef.get();
    let lastNumber = counterDoc.exists ? counterDoc.data().lastNumber : 0;
    const newNumber = lastNumber + 1;
    const workerId = "WORKER-" + String(newNumber).padStart(6, "0");

    // Upload images
    const personalPhotoFile = document.getElementById("personalPhoto").files[0];
    const idPhotoFile = document.getElementById("idPhoto").files[0];
    const criminalPhotoFile = document.getElementById("criminalPhoto").files[0];

    const personalPhotoURL = personalPhotoFile ? await uploadFile(personalPhotoFile, `personal_photos/${workerId}`) : "";
    const idPhotoURL = idPhotoFile ? await uploadFile(idPhotoFile, `id_photos/${workerId}`) : "";
    const criminalPhotoURL = criminalPhotoFile ? await uploadFile(criminalPhotoFile, `criminal_records/${workerId}`) : "";

    const data = {
      workerId: workerId,
      name: document.getElementById("name").value,
      nationalId: document.getElementById("nationalId").value,
      contractor: document.getElementById("contractor").value,
      jobTitle: document.getElementById("jobTitle").value,
      gates: document.getElementById("gates").value.split(","),
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      personalPhotoURL,
      idPhotoURL,
      criminalPhotoURL
    };

    await db.collection("workers").doc(workerId).set(data);
    await counterRef.update({ lastNumber: newNumber });

    alert("Worker added successfully with ID: " + workerId);

  } catch (error) {
    alert(error.message);
  }
}
</script>
